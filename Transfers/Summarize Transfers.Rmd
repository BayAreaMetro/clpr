---
title: "Summarize Transfers"
author: "David Ory"
output:
  html_document:
    theme: cosmo
    toc: yes
runtime: shiny
---

## Administration

#### Purpose
The anonymous Clipper data is potentially an excellent source for quantifying operator-to-operator transit movements.  Here, we seek to understand transfers in the travel model sense, i.e. a movement between an origin and destination that requires a tranfer between or within transit operators.  This definition differs from transfers as defined by certain transit agencies, which generally allow multiple boardings at no or reduced cost during a narrow time window.  Here, we will attempt to develop rules for each pair of operators to try and quantify the transfers of interest.  This script uses data derived from the anonymous Clipper data -- see `Extract Transfer for Random Weekday to CSV.R`.

#### _ISSUES_

#### _TODO_
2.  Make plots interactive and clean up
4.  Use charts to infer break points (top 10?)
5.  Build data set with both way transfers using data points (median? mean plus SD?)
6.  Add-in data for more months

## Overhead

#### Libraries
```{r overhead}
library(knitr)
library(stringr)
library(ggplot2)
suppressMessages(library(dplyr))
```

#### Knitr config
```{r config, include=FALSE}
knitr::opts_chunk$set(cache=TRUE)
```

## Data reads
```{r data-reads}
# Start with one month of data
load("M:/Data/Clipper/Transfers/From Anonymous/2013 - 3 Transfer Database for Random Weekdays.RData")
table(working.output$from_AgencyName)
# data_03_may_2013 <- working.output

```


```{r plot-both-way-function, echo=FALSE, cache=TRUE}
# Re-write the above chunk as a function
Make_to_from_plot <- function(transfer_df, a_string, b_string){
  
  # A to B
  a_to_b <- transfer_df %>%
    mutate(from_AgencyName = str_trim(from_AgencyName)) %>%
    mutate(to_AgencyName   = str_trim(to_AgencyName)) %>%
    filter(from_AgencyName == a_string) %>%
    filter(to_AgencyName   == b_string)
  
  a_to_b <- a_to_b %>%
    mutate(key_time = ifelse(!is.na(Diff_Min_TagOff_to_TagOn), Diff_Min_TagOff_to_TagOn, Diff_Min_TagOn_to_TagOn)) %>%
    group_by(Year, Month, CircadianDayOfWeek, RandomWeekID, key_time) %>%
    summarise(transfers = n()) %>%
    group_by(Year, Month, key_time) %>%
    summarise(typical_weekdays = n(), median_transfers = median(transfers)) %>%
    mutate(cumulative_median_transfers = cumsum(median_transfers)) %>%
    select(Year, Month, key_time, cumulative_median_transfers) %>%
    mutate(movement = paste(a_string," to ", b_string)) %>%
    filter(key_time > 0) %>%
    filter(key_time < 130)
  
  # B to A
  b_to_a <- transfer_df %>%
    mutate(from_AgencyName = str_trim(from_AgencyName)) %>%
    mutate(to_AgencyName   = str_trim(to_AgencyName)) %>%
    filter(from_AgencyName == b_string) %>%
    filter(to_AgencyName   == a_string)
  
  b_to_a <- b_to_a %>%
    mutate(key_time = ifelse(!is.na(Diff_Min_TagOff_to_TagOn), Diff_Min_TagOff_to_TagOn, Diff_Min_TagOn_to_TagOn)) %>%
    group_by(Year, Month, CircadianDayOfWeek, RandomWeekID, key_time) %>%
    summarise(transfers = n()) %>%
    group_by(Year, Month, key_time) %>%
    summarise(typical_weekdays = n(), median_transfers = median(transfers)) %>%
    mutate(cumulative_median_transfers = cumsum(median_transfers)) %>%
    select(Year, Month, key_time, cumulative_median_transfers) %>%
    mutate(movement = paste(b_string," to ", a_string)) %>%
    filter(key_time > 0) %>%
    filter(key_time < 130)
  
  # Merge and plot
  data.to_plot <- rbind(a_to_b, b_to_a)
  
  # Plot
  plot <- ggplot(data.to_plot, aes(x = key_time, y = cumulative_median_transfers, colour = movement, group = movement)) + 
    xlab("Time between Tags") + 
    ylab("Cumulative Transfers") + 
    geom_line() + 
    ggtitle(paste(a_string,"to/from", b_string))
  
  return(plot)
  
}

```

## Operator Plots
#### Prepare typical weekday data
```{r typical-weekday-data}
transfer_data <- working.output %>%
  mutate(from_AgencyName = str_trim(from_AgencyName)) %>%
  mutate(to_AgencyName   = str_trim(to_AgencyName)) %>%
  filter(CircadianDayOfWeek > 2) %>%
  filter(CircadianDayOfWeek < 6)
```

### SF Muni & BART
```{r sf_muni-bart}
plot <- Make_to_from_plot(transfer_data, 'SF Muni', 'BART')
plot

```

### AC Transit & BART
```{r ac_transit-bart}

plot <- Make_to_from_plot(transfer_data, 'AC Transit', 'BART')
plot

```

