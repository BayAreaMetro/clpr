---
title: "Build Transfer Database"
author: "David Ory"
output:
  html_document:
    theme: cosmo
    toc: yes
---
## Administration

#### Purpose
The anonymous Clipper data is potentially an excellent source for quantifying operator-to-operator transit movements.  Here, we seek to understand transfers in the travel model sense, i.e. a movement between an origin and destination that requires a tranfer between or within transit operators.  This definition differs from transfers as defined by certain transit agencies, which generally allow multiple boardings at no or reduced cost during a narrow time window.  Here, we implement a set of rules to build a database of transfers.  This script uses data derived from the anonymous Clipper data -- see `Extract Transfer for Random Weekday to CSV.R`.  Please see `To and From Interactive.Rmd` for an interactive charting engine of operator pairs.

#### Overhead
```{r overhead}
library(knitr)
library(stringr)
library(ggplot2)
suppressMessages(library(dplyr))
```

```{r config, include=FALSE}
knitr::opts_chunk$set(cache=TRUE)
```

#### Parameters
```{r parameters}
SAMPLING_RATE = 0.50

transfer_rules_df <- read.table(file = "transfer_rules_database.csv", header = TRUE, sep = ",", stringsAsFactors = FALSE)

output_file_string <- "Transfers by day by agency pair.csv"
```

## Processing Method
```{r processing-method}
Build_Database <- function(transfers_df, transactions_df, transfer_rules_df, sampling_rate_float, output_file_string, append_boolean){
  
  # Summarise the transfers for typical weekdays
  typical.weekday <- transfers_df %>%
    mutate(from_AgencyName = str_trim(from_AgencyName)) %>%
    mutate(to_AgencyName   = str_trim(to_AgencyName)) %>%
    filter(CircadianDayOfWeek > 2) %>%
    filter(CircadianDayOfWeek < 6) %>%
    mutate(key_time = ifelse(!is.na(Diff_Min_TagOff_to_TagOn), Diff_Min_TagOff_to_TagOn, Diff_Min_TagOn_to_TagOn)) %>%
    select(Year, Month, CircadianDayOfWeek, RandomWeekID, from_AgencyName, to_AgencyName, key_time)
  
  transfer.data <- inner_join(typical.weekday, transfer_rules_df, by = c("from_AgencyName", "to_AgencyName"))
  
  transfer.sum <- transfer.data %>%
    filter(key_time <= max_time) %>%
    select(-key_time, -max_time) %>%
    group_by(Year, Month, CircadianDayOfWeek, RandomWeekID, from_AgencyName, to_AgencyName) %>%
    summarise(sampled_transfers = n())
  
  # Join the transactions
  working.transactions <- transactions_df %>%
    mutate(AgencyName = str_trim(AgencyName))
  
  from_transactions <- working.transactions %>%
    select(from_AgencyName = AgencyName, from_Agency_Sampled_Transactions = Sampled_Transactions, Year, Month, CircadianDayOfWeek, RandomWeekID)
  
  to_transactions <- working.transactions %>%
    select(  to_AgencyName = AgencyName,   to_Agency_Sampled_Transactions = Sampled_Transactions, Year, Month, CircadianDayOfWeek, RandomWeekID)
  
  transfer.write <- left_join(transfer.sum,   from_transactions, by = c("Year", "Month", "CircadianDayOfWeek", "RandomWeekID", "from_AgencyName"))
  transfer.write <- left_join(transfer.write, to_transactions,   by = c("Year", "Month", "CircadianDayOfWeek", "RandomWeekID", "to_AgencyName"))
  
  # Estimate transfers & tranactions using the sample rate
  transfer.write <- transfer.write %>%
    mutate(estimated_transfers = sampled_transfers / SAMPLING_RATE) %>%
    mutate(estimated_from_agency_transactions = from_Agency_Sampled_Transactions / SAMPLING_RATE) %>% 
    mutate(estimated_to_agency_transactions   = to_Agency_Sampled_Transactions   / SAMPLING_RATE)
  
  # Write to disk
  if (append_boolean) {
    existing <- read.table(file = output_file_string, header = TRUE, sep = ",", stringsAsFactors = FALSE)
    transfer.write <- rbind(existing, transfer.write)
    
  } 
    
  write.csv(transfer.write, output_file_string, row.names = FALSE, quote = T)
  
  }

```

## Churn
### Year 2013
#### 2013 March
```{r 2013-march}
load("M:/Data/Clipper/Transfers/From Anonymous/extracts/2013 - 3 - 50 percent Transfer Database for Random Weekdays.RData")
transfers_df <- working.output

load("M:/Data/Clipper/Transfers/From Anonymous/extracts/2013 - 3 - 50 percent Transaction Database for Random Weekdays.RData")
transactions_df <- operator_counts

Build_Database(transfers_df, transactions_df, transfer_rules_df, SAMPLING_RATE, output_file_string, FALSE)
```


#### 2013 April
```{r 2013-april}
load("M:/Data/Clipper/Transfers/From Anonymous/extracts/2013 - 4 - 50 percent Transfer Database for Random Weekdays.RData")
transfers_df <- working.output

load("M:/Data/Clipper/Transfers/From Anonymous/extracts/2013 - 4 - 50 percent Transaction Database for Random Weekdays.RData")
transactions_df <- operator_counts

Build_Database(transfers_df, transactions_df, transfer_rules_df, SAMPLING_RATE, output_file_string, TRUE)
```

#### 2013 May
```{r 2013-may}
load("M:/Data/Clipper/Transfers/From Anonymous/extracts/2013 - 5 - 50 percent Transfer Database for Random Weekdays.RData")
transfers_df <- working.output

load("M:/Data/Clipper/Transfers/From Anonymous/extracts/2013 - 5 - 50 percent Transaction Database for Random Weekdays.RData")
transactions_df <- operator_counts

Build_Database(transfers_df, transactions_df, transfer_rules_df, SAMPLING_RATE, output_file_string, TRUE)
```

#### 2013 September
```{r 2013-september}
load("M:/Data/Clipper/Transfers/From Anonymous/extracts/2013 - 9 - 50 percent Transfer Database for Random Weekdays.RData")
transfers_df <- working.output

load("M:/Data/Clipper/Transfers/From Anonymous/extracts/2013 - 9 - 50 percent Transaction Database for Random Weekdays.RData")
transactions_df <- operator_counts

Build_Database(transfers_df, transactions_df, transfer_rules_df, SAMPLING_RATE, output_file_string, TRUE)
```

#### 2013 October
```{r 2013-october}
load("M:/Data/Clipper/Transfers/From Anonymous/extracts/2013 - 10 - 50 percent Transfer Database for Random Weekdays.RData")
transfers_df <- working.output

load("M:/Data/Clipper/Transfers/From Anonymous/extracts/2013 - 10 - 50 percent Transaction Database for Random Weekdays.RData")
transactions_df <- operator_counts

Build_Database(transfers_df, transactions_df, transfer_rules_df, SAMPLING_RATE, output_file_string, TRUE)
```

#### 2013 November
```{r 2013-november}
load("M:/Data/Clipper/Transfers/From Anonymous/extracts/2013 - 11 - 50 percent Transfer Database for Random Weekdays.RData")
transfers_df <- working.output

load("M:/Data/Clipper/Transfers/From Anonymous/extracts/2013 - 11 - 50 percent Transaction Database for Random Weekdays.RData")
transactions_df <- operator_counts

Build_Database(transfers_df, transactions_df, transfer_rules_df, SAMPLING_RATE, output_file_string, TRUE)
```

### Year 2014
#### 2014 March
```{r 2014-march}
load("M:/Data/Clipper/Transfers/From Anonymous/extracts/2014 - 3 - 50 percent Transfer Database for Random Weekdays.RData")
transfers_df <- working.output

load("M:/Data/Clipper/Transfers/From Anonymous/extracts/2014 - 3 - 50 percent Transaction Database for Random Weekdays.RData")
transactions_df <- operator_counts

Build_Database(transfers_df, transactions_df, transfer_rules_df, SAMPLING_RATE, output_file_string, TRUE)
```

#### 2014 April
```{r 2014-april}
load("M:/Data/Clipper/Transfers/From Anonymous/extracts/2014 - 4 - 50 percent Transfer Database for Random Weekdays.RData")
transfers_df <- working.output

load("M:/Data/Clipper/Transfers/From Anonymous/extracts/2014 - 4 - 50 percent Transaction Database for Random Weekdays.RData")
transactions_df <- operator_counts

Build_Database(transfers_df, transactions_df, transfer_rules_df, SAMPLING_RATE, output_file_string, TRUE)
```

#### 2014 May
```{r 2014-may}
load("M:/Data/Clipper/Transfers/From Anonymous/extracts/2014 - 5 - 50 percent Transfer Database for Random Weekdays.RData")
transfers_df <- working.output

load("M:/Data/Clipper/Transfers/From Anonymous/extracts/2014 - 5 - 50 percent Transaction Database for Random Weekdays.RData")
transactions_df <- operator_counts

Build_Database(transfers_df, transactions_df, transfer_rules_df, SAMPLING_RATE, output_file_string, TRUE)
```

#### 2014 September
```{r 2014-september}
load("M:/Data/Clipper/Transfers/From Anonymous/extracts/2014 - 9 - 50 percent Transfer Database for Random Weekdays.RData")
transfers_df <- working.output

load("M:/Data/Clipper/Transfers/From Anonymous/extracts/2014 - 9 - 50 percent Transaction Database for Random Weekdays.RData")
transactions_df <- operator_counts

Build_Database(transfers_df, transactions_df, transfer_rules_df, SAMPLING_RATE, output_file_string, TRUE)
```