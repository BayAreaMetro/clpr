---
title: "Build Transfer Database"
author: "David Ory"
date: "Thursday, November 06, 2014"
output:
  html_document:
    theme: cosmo
    toc: yes
---
## Administration

#### Purpose
The anonymous Clipper data is potentially an excellent source for quantifying operator-to-operator transit movements.  Here, we seek to understand transfers in the travel model sense, i.e. a movement between an origin and destination that requires a tranfer between or within transit operators.  This definition differs from transfers as defined by certain transit agencies, which generally allow multiple boardings at no or reduced cost during a narrow time window.  Here, we implement a set of rules to build a database of transfers.  This script uses data derived from the anonymous Clipper data -- see `Extract Transfer for Random Weekday to CSV.R`.  Please see `To and From Interactive.Rmd` for an interactive charting engine of operator pairs.

#### _ISSUES_

#### _TODO_
4.  Use charts to infer break points (top 10?)
6.  Build out input data base
7.  Build data set with both way transfers using data points
8.  Data set should have sampled transfers, estimated transfers, and transfer shares (or operator boarding to compute it)
8.  Add-in data for more months

#### Overhead
```{r overhead}
library(knitr)
library(stringr)
library(ggplot2)
suppressMessages(library(dplyr))
```

```{r config, include=FALSE}
knitr::opts_chunk$set(cache=TRUE)
```

#### Parameters
```{r parameters}
SAMPLING_RATE = 0.50
```

## Data reads
```{r data-reads}

# Clipper transfer and transaction extracts
# ~ 2013 March
load("M:/Data/Clipper/Transfers/From Anonymous/extracts/2013 - 3 - 50 percent Transfer Database for Random Weekdays.RData")
data_03_mar_2013_transfers <- working.output

load("M:/Data/Clipper/Transfers/From Anonymous/extracts/2013 - 3 - 50 percent Transaction Database for Random Weekdays.RData")
data_03_mar_2013_transactions <- operator_counts

# ~ 2013 April
load("M:/Data/Clipper/Transfers/From Anonymous/extracts/2013 - 4 - 50 percent Transfer Database for Random Weekdays.RData")
data_04_apr_2013_transfers <- working.output

load("M:/Data/Clipper/Transfers/From Anonymous/extracts/2013 - 4 - 50 percent Transaction Database for Random Weekdays.RData")
data_04_apr_2013_transactions <- operator_counts

load("M:/Data/Clipper/Transfers/From Anonymous/extracts/2013 - 5 - 50 percent Transfer Database for Random Weekdays.RData")
data_05_may_2013_transfers <- working.output

load("M:/Data/Clipper/Transfers/From Anonymous/extracts/2013 - 5 - 50 percent Transaction Database for Random Weekdays.RData")
data_05_may_2013_transactions <- operator_counts

# Combine
working.transfers    <- rbind(data_03_mar_2013_transfers,
                              data_04_apr_2013_transfers,    
                              data_05_may_2013_transfers)

working.transactions <- rbind(data_03_mar_2013_transactions, 
                              data_04_apr_2013_transactions, 
                              data_05_may_2013_transactions)

# Transfer rules
transfer.rules <- read.table(file = "transfer_rules_database.csv", header = TRUE, sep = ",", stringsAsFactors = FALSE)

# Clean up
remove(data_03_mar_2013_transfers,
       data_04_apr_2013_transfers,
       data_05_may_2013_transfers,
       data_03_mar_2013_transactions,
       data_04_apr_2013_transactions,
       data_05_may_2013_transactions)

```

## Processing
```{r data-processing-transfers}

# Summarise the transfers for typical weekdays
typical.weekday <- working.transfers %>%
  mutate(from_AgencyName = str_trim(from_AgencyName)) %>%
  mutate(to_AgencyName   = str_trim(to_AgencyName)) %>%
  filter(CircadianDayOfWeek > 2) %>%
  filter(CircadianDayOfWeek < 6) %>%
  mutate(key_time = ifelse(!is.na(Diff_Min_TagOff_to_TagOn), Diff_Min_TagOff_to_TagOn, Diff_Min_TagOn_to_TagOn)) %>%
  select(Year, Month, CircadianDayOfWeek, RandomWeekID, from_AgencyName, to_AgencyName, key_time)

transfer.data <- inner_join(typical.weekday, transfer.rules, by = c("from_AgencyName", "to_AgencyName"))

transfer.sum <- transfer.data %>%
  filter(key_time <= max_time) %>%
  select(-key_time, -max_time) %>%
  group_by(Year, Month, CircadianDayOfWeek, RandomWeekID, from_AgencyName, to_AgencyName) %>%
  summarise(sampled_transfers = n())

# Join the transactions
working.transactions <- working.transactions %>%
  mutate(AgencyName = str_trim(AgencyName))

from_transactions <- working.transactions %>%
  select(from_AgencyName = AgencyName, from_Agency_Sampled_Transactions = Sampled_Transactions, Year, Month, CircadianDayOfWeek, RandomWeekID)

to_transactions <- working.transactions %>%
  select(  to_AgencyName = AgencyName,   to_Agency_Sampled_Transactions = Sampled_Transactions, Year, Month, CircadianDayOfWeek, RandomWeekID)

transfer.write <- left_join(transfer.sum,   from_transactions, by = c("Year", "Month", "CircadianDayOfWeek", "RandomWeekID", "from_AgencyName"))
transfer.write <- left_join(transfer.write, to_transactions,   by = c("Year", "Month", "CircadianDayOfWeek", "RandomWeekID", "to_AgencyName"))

# Estimate transfers & tranactions using the sample rate
transfer.write <- transfer.write %>%
  mutate(estimated_transfers = sampled_transfers / SAMPLING_RATE) %>%
  mutate(estimated_from_agency_transactions = from_Agency_Sampled_Transactions / SAMPLING_RATE) %>% 
  mutate(estimated_to_agency_transactions   = to_Agency_Sampled_Transactions   / SAMPLING_RATE) 
  
```

## Write to disk
```{r writes}
write.csv(transfer.write, "M:/Data/Clipper/Transfers/From Anonymous/Transfers by day by agency pair.csv", row.names = FALSE, quote = T)
```

