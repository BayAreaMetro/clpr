<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>clpr-tutorial • clpr</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="clpr-tutorial">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">clpr</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/clpr-tutorial.html">clpr-tutorial</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>clpr-tutorial</h1>
            
            <h4 class="date">2018-09-05</h4>
      
      
      <div class="hidden name"><code>clpr-tutorial.Rmd</code></div>

    </div>

    
    
<div id="sampling-transactions" class="section level1">
<h1 class="hasAnchor">
<a href="#sampling-transactions" class="anchor"></a>Sampling Transactions</h1>
<p>Sample a day of transactions by user</p>
<p>Note that date must be formatted as below for now. YYYY-MM-DD</p>
<p>Note that we source a local R script that defines the database connection details.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(DBI)
<span class="kw">library</span>(dbplyr)
<span class="kw">library</span>(dplyr)
<span class="kw">library</span>(clpr)
<span class="kw">source</span>(<span class="st">"~/.keys/rs.R"</span>)
rs &lt;-<span class="st"> </span><span class="kw">connect_rs</span>()</code></pre></div>
<p>First, let’s pull a sample of transactions in a given day using <code>sample_day_of_transactions</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">date &lt;-<span class="st"> "2016-04-25"</span>
transactions_df &lt;-<span class="st"> </span><span class="kw"><a href="../reference/sample_day_of_transactions.html">sample_day_of_transactions</a></span>(rs,date,<span class="dt">n_users=</span><span class="dv">100</span>)</code></pre></div>
<p>Use the <code>as_rides</code> function to change the unit of observation from transactions to rides, where a ride is a ride on an operator.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">rides_df &lt;-<span class="st"> </span><span class="kw"><a href="../reference/as_rides.html">as_rides</a></span>(transactions_df)</code></pre></div>
<p>We can also create a dataframe summarizing transfers within a given time window (in minutes), using the <code>create_transfer_df</code> function.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">transfer_df &lt;-<span class="st"> </span><span class="kw"><a href="../reference/create_transfer_df.html">create_transfer_df</a></span>(rides_df, <span class="dv">120</span>) <span class="co">#120 minutes</span>
<span class="kw">head</span>(transfer_df)
<span class="co">#&gt; # A tibble: 6 x 7</span>
<span class="co">#&gt; # Groups:   participantname.transfer [3]</span>
<span class="co">#&gt;   participantname.transfer participantname from_operator_id to_operator_id</span>
<span class="co">#&gt;   &lt;chr&gt;                    &lt;chr&gt;                      &lt;int&gt;          &lt;int&gt;</span>
<span class="co">#&gt; 1 AC Transit               AC Transit                     1              1</span>
<span class="co">#&gt; 2 AC Transit               BART                           1              4</span>
<span class="co">#&gt; 3 BART                     BART                           4              4</span>
<span class="co">#&gt; 4 BART                     Napa Solano                    4              9</span>
<span class="co">#&gt; 5 BART                     SF Muni                        4             18</span>
<span class="co">#&gt; 6 East Bay                 SF Muni                        8             18</span>
<span class="co">#&gt; # ... with 3 more variables: num_transfers &lt;dbl&gt;, num_discounted &lt;int&gt;,</span>
<span class="co">#&gt; #   transfer_revenue &lt;dbl&gt;</span></code></pre></div>
<p>Alternatively, we can use the <code>as_bart_journeys</code> function to change the unit of observation from transactions to rides on BART only, with additional information about the rides that individuals may have taken before or after boarding BART. For example, taking a ferry and then BART.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">bart_od &lt;-<span class="st"> </span><span class="kw"><a href="../reference/as_bart_journeys.html">as_bart_journeys</a></span>(transactions_df)</code></pre></div>
<p>The outcome includes the time of the previous transaction to BART tag-on. For example, a user tagged off of the ferry at 7:05 and then onto BART at 7:20. Or, a user tagged onto an SF Muni bus at 7:00 and then onto BART at 7:30. It also includes the time they tagged onto the following ride.</p>
<p>We can use the convenience function <code>spread_time_column</code> to spread the timestamp column into day of year, month, hour, and minute integers.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">out_time_df &lt;-<span class="st"> </span><span class="kw"><a href="../reference/spread_time_column.html">spread_time_column</a></span>(bart_od<span class="op">$</span>transaction_time, <span class="dt">prefix=</span><span class="st">"tag_out_"</span>)
in_time_df &lt;-<span class="st"> </span><span class="kw"><a href="../reference/spread_time_column.html">spread_time_column</a></span>(bart_od<span class="op">$</span>time_of_previous, <span class="dt">prefix=</span><span class="st">"tag_on_"</span>)
bart_od_nicetime &lt;-<span class="st"> </span><span class="kw">cbind</span>(bart_od,in_time_df,out_time_df)</code></pre></div>
<p>This can make working with the time data easier. For example, plotting a histogram of the tag on hour.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">hist</span>(bart_od_nicetime<span class="op">$</span>tag_on_hour, <span class="dt">breaks=</span><span class="dv">24</span>)</code></pre></div>
<p><img src="clpr-tutorial_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
<p>We can also pull a full day of transactions using <code>day_of_transactions</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">rs &lt;-<span class="st"> </span><span class="kw">connect_rs</span>()
date &lt;-<span class="st"> "2016-04-25"</span>
transactions_tbl &lt;-<span class="st"> </span><span class="kw"><a href="../reference/day_of_transactions.html">day_of_transactions</a></span>(rs,date)
transactions_df &lt;-<span class="st"> </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/reexports.html">as_tibble</a></span>(transactions_tbl)
time_df &lt;-<span class="st"> </span><span class="kw"><a href="../reference/spread_time_column.html">spread_time_column</a></span>(transactions_df<span class="op">$</span>transaction_time, <span class="dt">prefix=</span><span class="st">"trnsct_"</span>)
transactions_df &lt;-<span class="st"> </span><span class="kw">cbind</span>(transactions_df,time_df)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">hist</span>(transactions_df<span class="op">$</span>trnsct_hour, <span class="dt">breaks=</span><span class="dv">24</span>)</code></pre></div>
<p><img src="clpr-tutorial_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
<p>Then we can calculate the average number of transactions per product type in the day:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">rides_df &lt;-<span class="st"> </span><span class="kw"><a href="../reference/as_rides.html">as_rides</a></span>(transactions_tbl)

rides_df &lt;-<span class="st"> </span><span class="kw"><a href="../reference/get_product_description.html">get_product_description</a></span>(rides_df)

rides_per_user &lt;-<span class="st"> </span>rides_df <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(cardid_anony,product_description) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">transmute</a></span>(<span class="dt">total_rides=</span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/n.html">n</a></span>())

rides_per_type &lt;-<span class="st"> </span>rides_per_user <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(product_description) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span>(<span class="dt">mean_rides=</span><span class="kw">mean</span>(total_rides))

knitr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/knitr/topics/kable">kable</a></span>(<span class="kw">head</span>(<span class="kw"><a href="http://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span>(rides_per_type,<span class="kw"><a href="http://dplyr.tidyverse.org/reference/desc.html">desc</a></span>(mean_rides))))</code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">product_description</th>
<th align="right">mean_rides</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">FAST Route 90 Senior 31-day Rolling Pass</td>
<td align="right">7.727273</td>
</tr>
<tr class="even">
<td align="left">Santa Rosa CityBus S/D 31-day rolling pass</td>
<td align="right">6.375000</td>
</tr>
<tr class="odd">
<td align="left">FAST Route 90 Youth 31-day Rolling Pass</td>
<td align="right">6.000000</td>
</tr>
<tr class="even">
<td align="left">WestCAT Senior 31-Day Pass</td>
<td align="right">6.000000</td>
</tr>
<tr class="odd">
<td align="left">SF Muni 3 Day Rolling Pass</td>
<td align="right">5.597938</td>
</tr>
<tr class="even">
<td align="left">East Bay Regional Adult Local 31-Day Pass</td>
<td align="right">5.100457</td>
</tr>
</tbody>
</table>
</div>
<div id="contributing" class="section level1">
<h1 class="hasAnchor">
<a href="#contributing" class="anchor"></a>Contributing</h1>
<p>You can contribute code, data, or questions. Please feel free to <a href="https://github.com/BayAreaMetro/clpr/issues">open an issue</a> with any questions about how to use the package.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#sampling-transactions">Sampling Transactions</a></li>
      <li><a href="#contributing">Contributing</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Yeeling Tse, Tom Buckley.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
